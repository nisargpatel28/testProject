{"ast":null,"code":"\"use strict\";\n\nvar fs = require('fs');\n\nvar rm = require('rimraf');\n\nmodule.exports = exports;\nvar versionArray = process.version.substr(1).replace(/-.*$/, '').split('.').map(function (item) {\n  return +item;\n});\nvar napi_multiple_commands = ['build', 'clean', 'configure', 'package', 'publish', 'reveal', 'testbinary', 'testpackage', 'unpublish'];\nvar napi_build_version_tag = 'napi_build_version=';\n\nmodule.exports.get_napi_version = function () {\n  // returns the non-zero numeric napi version or undefined if napi is not supported.\n  var version = process.versions.napi; // can be undefined\n\n  if (!version) {\n    // this code should never need to be updated\n    if (versionArray[0] === 9 && versionArray[1] >= 3) version = 2; // 9.3.0+\n    else if (versionArray[0] === 8) version = 1; // 8.0.0+\n  }\n\n  return version;\n};\n\nmodule.exports.get_napi_version_as_string = function () {\n  // returns the napi version as a string or an empty string if napi is not supported.\n  var version = module.exports.get_napi_version();\n  return version ? '' + version : '';\n};\n\nmodule.exports.validate_package_json = function (package_json) {\n  // return err\n  var binary = package_json.binary;\n  var module_path_ok = binary.module_path && binary.module_path.indexOf('{napi_build_version}') !== -1;\n  var remote_path_ok = binary.remote_path && binary.remote_path.indexOf('{napi_build_version}') !== -1;\n  var package_name_ok = binary.package_name && binary.package_name.indexOf('{napi_build_version}') !== -1;\n  var napi_build_versions = module.exports.get_napi_build_versions(package_json);\n\n  if (napi_build_versions) {\n    napi_build_versions.forEach(function (napi_build_version) {\n      if (!(parseInt(napi_build_version, 10) === napi_build_version && napi_build_version > 0)) {\n        throw new Error(\"All values specified in napi_versions must be positive integers.\");\n      }\n    });\n  }\n\n  if (napi_build_versions && (!module_path_ok || !remote_path_ok && !package_name_ok)) {\n    throw new Error(\"When napi_versions is specified; module_path and either remote_path or \" + \"package_name must contain the substitution string '{napi_build_version}`.\");\n  }\n\n  if ((module_path_ok || remote_path_ok || package_name_ok) && !napi_build_versions) {\n    throw new Error(\"When the substitution string '{napi_build_version}` is specified in \" + \"module_path, remote_path, or package_name; napi_versions must also be specified.\");\n  }\n\n  if (napi_build_versions && !module.exports.get_best_napi_build_version(package_json)) {\n    throw new Error('The N-API version of this Node instance is ' + module.exports.get_napi_version() + '. ' + 'This module supports N-API version(s) ' + module.exports.get_napi_build_versions(package_json) + '. ' + 'This Node instance cannot run this module.');\n  }\n};\n\nmodule.exports.expand_commands = function (package_json, commands) {\n  var expanded_commands = [];\n  var napi_build_versions = module.exports.get_napi_build_versions(package_json);\n  commands.forEach(function (command) {\n    if (napi_build_versions && command.name === 'install') {\n      var napi_build_version = module.exports.get_best_napi_build_version(package_json);\n      var args = napi_build_version ? [napi_build_version_tag + napi_build_version] : [];\n      expanded_commands.push({\n        name: command.name,\n        args: args\n      });\n    } else if (napi_build_versions && napi_multiple_commands.includes(command.name)) {\n      napi_build_versions.forEach(function (napi_build_version) {\n        var args = command.args.slice();\n        args.push(napi_build_version_tag + napi_build_version);\n        expanded_commands.push({\n          name: command.name,\n          args: args\n        });\n      });\n    } else {\n      expanded_commands.push(command);\n    }\n  });\n  return expanded_commands;\n};\n\nmodule.exports.get_napi_build_versions = function (package_json) {\n  var napi_build_versions = [];\n\n  if (package_json.binary && package_json.binary.napi_versions) {\n    // remove duplicates\n    package_json.binary.napi_versions.forEach(function (napi_version) {\n      if (!napi_build_versions.includes(napi_version)) napi_build_versions.push(napi_version);\n    });\n  }\n\n  return napi_build_versions.length ? napi_build_versions : undefined;\n};\n\nmodule.exports.get_command_arg = function (napi_build_version) {\n  return napi_build_version_tag + napi_build_version;\n};\n\nmodule.exports.get_napi_build_version_from_command_args = function (command_args) {\n  for (var i = 0; i < command_args.length; i++) {\n    var arg = command_args[i];\n\n    if (arg.indexOf(napi_build_version_tag) === 0) {\n      return parseInt(arg.substr(napi_build_version_tag.length), 10);\n    }\n  }\n\n  return undefined;\n};\n\nmodule.exports.swap_build_dir_out = function (napi_build_version) {\n  if (napi_build_version) {\n    rm.sync(module.exports.get_build_dir(napi_build_version));\n    fs.renameSync('build', module.exports.get_build_dir(napi_build_version));\n  }\n};\n\nmodule.exports.swap_build_dir_in = function (napi_build_version) {\n  if (napi_build_version) {\n    rm.sync('build');\n    fs.renameSync(module.exports.get_build_dir(napi_build_version), 'build');\n  }\n};\n\nmodule.exports.get_build_dir = function (napi_build_version) {\n  return 'build-tmp-napi-v' + napi_build_version;\n};\n\nmodule.exports.get_best_napi_build_version = function (package_json) {\n  var best_napi_build_version = 0;\n  var napi_build_versions = module.exports.get_napi_build_versions(package_json);\n\n  if (napi_build_versions) {\n    var our_napi_version = module.exports.get_napi_version();\n    napi_build_versions.forEach(function (napi_build_version) {\n      if (napi_build_version > best_napi_build_version && napi_build_version <= our_napi_version) {\n        best_napi_build_version = napi_build_version;\n      }\n    });\n  }\n\n  return best_napi_build_version === 0 ? undefined : best_napi_build_version;\n};","map":null,"metadata":{},"sourceType":"script"}